<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>JANE'S UNIVERSE (雙平台完美版)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Arial', sans-serif; user-select: none; -webkit-user-select: none; }
        
        /* 歡迎畫面 */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; transition: opacity 0.5s;
        }
        #start-btn {
            padding: 15px 40px; font-size: 24px; border: 2px solid #00ffff; color: #00ffff;
            background: transparent; border-radius: 50px; cursor: pointer; margin-top: 30px;
            box-shadow: 0 0 15px #00ffff; transition: 0.3s;
        }
        #start-btn:hover { background: #00ffff; color: black; }

        /* UI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .brand-logo {
            position: absolute; top: 20px; left: 20px;
            color: white; font-size: 24px; font-weight: bold; text-shadow: 0 0 10px cyan;
            letter-spacing: 2px;
        }
        .controls-hint {
            position: absolute; bottom: 20px; right: 20px;
            color: #888; font-size: 14px; text-align: right;
        }

        /* 互動提示 */
        #interaction-ui {
            position: absolute; bottom: 180px; width: 100%; text-align: center;
            display: none; pointer-events: none;
        }
        .msg-box {
            display: inline-block; background: rgba(0, 0, 0, 0.8); color: white;
            padding: 15px 30px; border-radius: 30px; font-size: 18px;
            border: 1px solid rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            backdrop-filter: blur(5px);
        }

        /* 搖桿區域 */
        #joystick-zone {
            position: absolute; bottom: 50px; left: 50px; width: 150px; height: 150px;
            z-index: 10; pointer-events: auto;
        }

        @media (max-width: 768px) {
            .brand-logo { font-size: 18px; }
            #interaction-ui { bottom: 40%; }
            #joystick-zone { bottom: 30px; left: 30px; }
            .controls-hint { display: none; } /* 手機不顯示鍵盤提示 */
        }
    </style>
</head>
<body>

    <!-- 歡迎畫面 -->
    <div id="start-screen">
        <h1 style="text-align: center; margin: 0; font-size: 40px; text-shadow: 0 0 20px cyan;">JANE'S WORLD</h1>
        <p style="color: #aaa; margin-top: 10px;">Exploring the Digital Universe</p>
        <button id="start-btn">ENTER WORLD</button>
    </div>

    <!-- UI 層 -->
    <div id="ui-layer">
        <div class="brand-logo">JANE'S PORTFOLIO</div>
        <div class="controls-hint">
            電腦：W A S D 移動 | Enter 互動<br>
            手機：左側搖桿 | 點擊互動
        </div>
    </div>

    <!-- 搖桿區域 -->
    <div id="joystick-zone"></div>

    <!-- 互動提示 -->
    <div id="interaction-ui">
        <div class="msg-box">
            <strong id="portal-title" style="font-size: 22px; color: cyan;">標題</strong><br>
            <span style="font-size:14px; color:#ffff00; margin-top: 5px; display:block;">點擊 / Enter 進入</span>
        </div>
    </div>

    <!-- 搖桿套件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- 全域變數 ---
        let scene, camera, renderer, clock;
        let player, mixer, actions = {}, activeAction, previousAction;
        let portals = [];
        let isGameActive = false;

        // 輸入狀態
        const inputState = {
            keyFwd: 0,  // 鍵盤前後
            keyTurn: 0, // 鍵盤左右
            joyFwd: 0,  // 搖桿前後
            joyTurn: 0  // 搖桿左右
        };

        // 1. 啟動按鈕
        document.getElementById('start-btn').addEventListener('click', () => {
            const screen = document.getElementById('start-screen');
            screen.style.opacity = '0';
            setTimeout(() => {
                screen.style.display = 'none';
                isGameActive = true;
                // 播放背景音樂可以在這裡加入
            }, 500);
        });

        // 2. 初始化
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050510);
            scene.fog = new THREE.Fog(0x050510, 10, 90);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, -10);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // 燈光
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
            hemiLight.position.set(0, 20, 0);
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(-3, 10, -10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // 地板與網格
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 200),
                new THREE.MeshPhongMaterial({ color: 0x111111, depthWrite: false })
            );
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            const grid = new THREE.GridHelper(200, 40, 0x00ffff, 0x222222);
            grid.material.opacity = 0.2;
            grid.material.transparent = true;
            scene.add(grid);

            // 星空
            const starGeo = new THREE.BufferGeometry();
            const starPos = [];
            for(let i=0; i<1500; i++) {
                starPos.push((Math.random() - 0.5) * 200); // x
                starPos.push(Math.random() * 100);         // y (只在天空)
                starPos.push((Math.random() - 0.5) * 200); // z
            }
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
            const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.3 }));
            scene.add(stars);

            // 傳送門
            createPortal(-8, 5, 0xff0080, "Instagram", "https://www.instagram.com");
            createPortal(0, 15, 0x00ffff, "個人履歷", "https://www.google.com");
            createPortal(8, 5, 0xffff00, "YouTube", "https://www.youtube.com");

            // 載入機器人
            const loader = new GLTFLoader();
            loader.load('https://threejs.org/examples/models/gltf/RobotExpressive/RobotExpressive.glb', function (gltf) {
                player = gltf.scene;
                player.scale.set(0.5, 0.5, 0.5);
                scene.add(player);

                mixer = new THREE.AnimationMixer(player);
                const anims = gltf.animations;
                const getClip = (name) => {
                    const clip = THREE.AnimationClip.findByName(anims, name);
                    return clip ? mixer.clipAction(clip) : null;
                };

                actions['Idle'] = getClip('Idle');
                actions['Walking'] = getClip('Walking');
                actions['Running'] = getClip('Running');
                
                activeAction = actions['Idle'];
                if(activeAction) activeAction.play();
            });

            clock = new THREE.Clock();
            animate();
        }

        function createPortal(x, z, color, title, url) {
            const group = new THREE.Group();
            
            // 光柱
            const geo = new THREE.BoxGeometry(2, 4, 0.2);
            const mat = new THREE.MeshPhongMaterial({ color: color, emissive: color, emissiveIntensity: 0.8, transparent: true, opacity: 0.8 });
            const portal = new THREE.Mesh(geo, mat);
            portal.position.y = 2;
            
            // 地板光圈
            const ring = new THREE.Mesh(
                new THREE.RingGeometry(1.5, 2, 32),
                new THREE.MeshBasicMaterial({ color: color, side: THREE.DoubleSide })
            );
            ring.rotation.x = -Math.PI / 2;
            ring.position.y = 0.05;

            group.add(portal);
            group.add(ring);
            group.position.set(x, 0, z);
            group.userData = { title, url };
            
            scene.add(group);
            portals.push(group);
        }

        // 3. 輸入控制系統 (關鍵修復)
        
        // A. 鍵盤控制 (使用 e.code 避免輸入法問題)
        const keysPressed = {};
        window.addEventListener('keydown', (e) => { keysPressed[e.code] = true; });
        window.addEventListener('keyup', (e) => { keysPressed[e.code] = false; });

        // B. 搖桿控制
        const joystickManager = nipplejs.create({
            zone: document.getElementById('joystick-zone'),
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'cyan'
        });

        joystickManager.on('move', (evt, data) => {
            if (data.vector) {
                inputState.joyFwd = data.vector.y; 
                inputState.joyTurn = -data.vector.x; 
            }
        });

        joystickManager.on('end', () => {
            inputState.joyFwd = 0;
            inputState.joyTurn = 0;
        });

        // 4. 動畫迴圈
        function animate() {
            requestAnimationFrame(animate);
            if (!isGameActive) return;

            const dt = clock.getDelta();
            if (mixer) mixer.update(dt);

            if (player) {
                // --- 1. 計算鍵盤輸入 ---
                inputState.keyFwd = 0;
                inputState.keyTurn = 0;

                // 支援 W/S/Up/Down
                if (keysPressed['KeyW'] || keysPressed['ArrowUp']) inputState.keyFwd = 1;
                if (keysPressed['KeyS'] || keysPressed['ArrowDown']) inputState.keyFwd = -1;
                
                // 支援 A/D/Left/Right
                if (keysPressed['KeyA'] || keysPressed['ArrowLeft']) inputState.keyTurn = 1;
                if (keysPressed['KeyD'] || keysPressed['ArrowRight']) inputState.keyTurn = -1;

                // --- 2. 合併輸入 (搖桿優先，若搖桿沒動則用鍵盤) ---
                // 這樣電腦版和手機版都能完美運作
                const finalFwd = inputState.joyFwd !== 0 ? inputState.joyFwd : inputState.keyFwd;
                const finalTurn = inputState.joyTurn !== 0 ? inputState.joyTurn : inputState.keyTurn;

                const moveSpeed = 10 * dt;
                const rotSpeed = 3 * dt;

                // --- 3. 執行移動 ---
                if (Math.abs(finalFwd) > 0.1) {
                    player.translateZ(finalFwd * moveSpeed);
                    fadeToAction('Running', 0.2);
                } else {
                    fadeToAction('Idle', 0.2);
                }

                if (Math.abs(finalTurn) > 0.1) {
                    player.rotation.y += finalTurn * rotSpeed;
                }

                // --- 4. 攝影機跟隨 ---
                const offset = new THREE.Vector3(0, 6, -12);
                const target = offset.applyMatrix4(player.matrixWorld);
                camera.position.lerp(target, 0.1);
                camera.lookAt(player.position.x, player.position.y + 2, player.position.z);

                // --- 5. 傳送門互動 ---
                let nearPortal = null;
                portals.forEach(p => {
                    p.children[0].rotation.y += 0.02; 
                    if (player.position.distanceTo(p.position) < 3) nearPortal = p;
                });

                const ui = document.getElementById('interaction-ui');
                const title = document.getElementById('portal-title');
                
                if (nearPortal) {
                    ui.style.display = 'block';
                    title.innerText = nearPortal.userData.title;
                    
                    // 電腦版 Enter 鍵監聽
                    if (keysPressed['Enter']) {
                        window.open(nearPortal.userData.url, '_blank');
                        keysPressed['Enter'] = false; // 避免重複觸發
                    }
                } else {
                    ui.style.display = 'none';
                }
            }

            renderer.render(scene, camera);
        }

        // 手機版：點擊螢幕也可以進入傳送門
        window.addEventListener('click', (e) => {
            // 避免點到搖桿也觸發
            if(e.target.closest('#joystick-zone')) return;

            const ui = document.getElementById('interaction-ui');
            if (ui.style.display === 'block' && player) {
                 let nearest = null;
                 let minDist = 999;
                 portals.forEach(p => {
                     const d = player.position.distanceTo(p.position);
                     if(d < 3.5 && d < minDist) { nearest = p; minDist = d; }
                 });
                 if(nearest) window.open(nearest.userData.url, '_blank');
            }
        });

        function fadeToAction(name, duration) {
            if (!actions[name] || activeAction === actions[name]) return;
            previousAction = activeAction;
            activeAction = actions[name];
            previousAction.fadeOut(duration);
            activeAction.reset().fadeIn(duration).play();
        }

        window.addEventListener('resize', () => {
            if(camera && renderer) {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            }
        });

        init();
    </script>
</body>
</html>